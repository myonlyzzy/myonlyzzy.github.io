<!doctype html>
<html lang="en-us">
<head>

    <meta charset="utf-8">
    <meta name="generator" content="Hugo 0.53" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title> | Myonlyzzy Blog</title>
    <meta property="og:title" content=" - Myonlyzzy Blog">
    <meta property="og:type" content="article">
        
        
    <meta name="Keywords" content="golang,go语言,kubernetes,容器,docker,k8s">
    <meta name="description" content="">
        
    <meta name="author" content="myonlyzzy">
    <meta property="og:url" content="https://myonlyzzy.github.io/post/http2grpc/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="/css/normalize.css">
    
        <link rel="stylesheet" href="/css/prism.css">
    
    <link rel="stylesheet" href="/css/style.css">
    <script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>

    


    
    
</head>

<body>
<header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://myonlyzzy.github.io">
                        Myonlyzzy Blog
                    </a>
                
                <p class="description">专注与golang k8s</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://myonlyzzy.github.io">首页</a>
                    
                    <a  href="https://myonlyzzy.github.io/" title="Home">Home</a>
                    
                    <a  href="https://myonlyzzy.github.io/about/" title="关于">关于</a>
                    
                    <a  href="https://myonlyzzy.github.io/works/" title="工作">工作</a>
                    
                    <a  href="https://myonlyzzy.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://myonlyzzy.github.io/about/" title="About">About</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>


<div id="body">
    <div class="container">
        <div class="col-group">

            <div class="col-8" id="main">
                <div class="res-cons">
                    <article class="post">
                        <header>
                            <h1 class="post-title"></h1>
                        </header>
                        <date class="post-meta meta-date">
                            1年1月1日
                        </date>
                        
                        
                        <div class="post-content">
                            

<h1 id="http2">Http2</h1>

<h2 id="http1-0-http1-1">http1.0&amp;http1.1</h2>

<ul>
<li>http请求发送接收的过程</li>
</ul>

<p><img src="/Users/myonlyzzy/Downloads/http1.0.png" alt="http1.0" /></p>

<p><img src="/Users/myonlyzzy/Downloads/http1.1.png" alt="http1.1" /></p>

<p>​</p>

<p>​</p>

<ul>
<li><p>Http1.0 http1.1 存在的问题</p>

<ol>
<li>http1.1 虽然可以通过keepalive 实现链接复用,但是没有实现请求复用.仍然要通过顺序发送和接收请求</li>
<li>http协议头浪费资源</li>
<li>服务端不能推送数据而提高加载速度</li>
</ol></li>
</ul>

<p><img src="/Users/myonlyzzy/Desktop/屏幕快照 2018-03-23 下午2.47.41.png" alt="屏幕快照 2018-03-23 下午2.47.41" /></p>

<p>​</p>

<h2 id="http2-1">http2</h2>

<p><strong>设计http2 的目的</strong></p>

<ol>
<li>HTTP/2 通过支持完整的请求与响应复用来减少延迟。</li>
<li>通过有效压缩 HTTP 标头字段将协议开销降至最低。</li>
<li>同时增加对请求优先级和服务器推送的支持</li>
</ol>

<h2 id="请求复用">请求复用</h2>

<p><img src="/Users/myonlyzzy/Downloads/138606-37ea7846b10ea092.png" alt="138606-37ea7846b10ea092" /></p>

<h2 id="二进制分帧层">二进制分帧层</h2>

<blockquote>
<p>数据流：已建立的连接内的双向字节流，可以承载一条或多条消息。</p>

<p>消息：与逻辑请求或响应消息对应的完整的一系列帧。</p>

<p>帧：HTTP/2 通信的最小单位，每个帧都包含帧头，至少也会标识出当前帧所属的数据流。</p>
</blockquote>

<p><img src="/Users/myonlyzzy/Desktop/binary_framing_layer01.svg" alt="binary_framing_layer01" /></p>

<p><img src="/Users/myonlyzzy/Desktop/屏幕快照 2018-03-28 下午3.56.36.png" alt="屏幕快照 2018-03-28 下午3.56.36" /></p>

<p><img src="/Users/myonlyzzy/Downloads/streams_messages_frames01.svg" alt="streams_messages_frames01" /></p>

<ul>
<li>所有通信都在一个 TCP 连接上完成，此连接可以承载任意数量的双向数据流。</li>
<li>每个数据流都有一个唯一的标识符和可选的优先级信息，用于承载双向消息。</li>
<li>每条消息都是一条逻辑 HTTP 消息（例如请求或响应），包含一个或多个帧。</li>
<li>帧是最小的通信单位，承载着特定类型的数据，例如 HTTP 标头、消息负载，等等。 来自不同数据流的帧可以交错发送，然后再根据每个帧头的数据流标识符重新组装。</li>
</ul>

<h2 id="请求和响应复用">请求和响应复用</h2>

<p><img src="/Users/myonlyzzy/Downloads/multiplexing01.svg" alt="multiplexing01" /></p>

<p><img src="/Users/myonlyzzy/Downloads/138606-37ea7846b10ea092.png" alt="138606-37ea7846b10ea092" /></p>

<ul>
<li>并行交错地发送多个请求，请求之间互不影响</li>
<li>并行交错地发送多个响应，响应之间互不干扰</li>
<li>使用一个连接并行发送多个请求和响应</li>
</ul>

<h2 id="头部压缩">头部压缩</h2>

<ul>
<li>在http1.x中http数据包的头部都是以文本编码的形式发送,浪费大量网络资源,HTTP/2 使用 HPACK 压缩格式压缩请求和响应标头元数据</li>
</ul>

<p>HPACK 中有2个索引表 静态索引表和动态索引表,由客户端和服务端共同维护。</p>

<p>### 静态索引表</p>

<p>​ 静态表是预先定义的常用的头部数据。共61个索引。</p>

<p><img src="/Users/myonlyzzy/Desktop/屏幕快照 2018-03-30 上午9.49.00.png" alt="屏幕快照 2018-03-30 上午9.49.00" /></p>

<p>### 动态索引表</p>

<pre><code>当遇到的值不在静态索引表中时就会用到动态索引表。动态索引表是一个先进先出有大小限制的表。
</code></pre>

<p>如果一个头部从来没有出现过就会把它插入到动态表中。下次同名的值就会被索引替换。</p>

<ol>
<li>一个连接对应一个表</li>
<li>动态表大小=(每个Header的字节数的和+32)*键值对个数，最大字节数有Setting帧控制。</li>
</ol>

<p>### huffman编码</p>

<p>huffman 编码是一个根据字符出现的概率重新编排字符的二进制代码，从而压缩概率高的字符串，进而压缩整个串的长度。如果不了解的话，建议先去学习一下，这里不再赘述。</p>

<p>http2 使用的huffman 编码是静态的，是根据过去大量的 Http 头的数据从而选出的编码方案。整个静态表在这里 <a href="http://httpwg.org/specs/rfc7541.html#huffman.code">http://httpwg.org/specs/rfc7541.html#huffman.code</a></p>

<p>### EXample</p>

<pre><code>  :method: GET
  :scheme: http
  :path: /
  :authority: www.example.com
</code></pre>

<pre><code>  8286 8441 8cf1 e3c2 e5f2 3a6b a0ab 90f4 ff     

</code></pre>

<p>82 = 10000010 -&gt; 静态表Index = 2 -&gt; <code>:method: GET</code></p>

<p>86 = 10000110 -&gt; 静态表Index = 6 -&gt; <code>:scheme: http</code></p>

<p>84 = 10000100 -&gt; 静态表Index = 4 -&gt; <code>:path: /</code></p>

<p>41 = 01000001 -&gt; name = 静态表1 = <code>:authority</code></p>

<p>接着解析12个字节为 huffman 编码后的字符</p>

<p>f1e3 c2e5 f23a 6ba0 ab90 f4ff， 查表可知为www.example.com</p>

<h2 id="服务端推送">服务端推送</h2>

<p>HTTP/2 新增的另一个强大的新功能是，服务器可以对一个客户端请求发送多个响应。 换句话说，除了对最初请求的响应外，服务器还可以向客户端推送额外资源（图 12-5），而无需客户端明确地请求</p>

<p><img src="/Users/myonlyzzy/Downloads/push01.svg" alt="push01" /></p>

<ul>
<li><p>所有服务端推送数据流的帧类型都是PUSH_PROMISE,而且这个帧会优先于请求推送资源。</p></li>

<li><p>客户端接收到PUSH_PROMISE帧后会根据自身情况拒绝数据流,例如已经缓存的数据</p></li>

<li><p>客户端可以限制并行推送的数据流数量,限制推送的数据量,停用服务器推送。</p></li>
</ul>

<p>​</p>

<h2 id="数据流优先级">数据流优先级</h2>

<p>将 HTTP 消息分解为很多独立的帧之后，我们就可以复用多个数据流中的帧，客户端和服务器交错发送和传输这些帧的顺序就成为关键的性能决定因素。为了做到这一点，HTTP/2 标准允许每个数据流都有一个关联的权重和依赖关系：</p>

<ul>
<li>可以向每个数据流分配一个介于 1 至 256 之间的整数。</li>
<li>每个数据流与其他数据流之间可以存在显式依赖关系。</li>
</ul>

<p>数据流依赖关系和权重的组合让客户端可以构建和传递“优先级树”，表明它倾向于如何接收响应。反过来，服务器可以使用此信息通过控制 CPU、内存和其他资源的分配设定数据流处理的优先级，在资源数据可用之后，带宽分配可以确保将高优先级响应以最优方式传输至客户端。</p>

<p><img src="/Users/myonlyzzy/Downloads/stream_prioritization01.svg" alt="stream_prioritization01" /></p>

<p>HTTP/2 内的数据流依赖关系通过将另一个数据流的唯一标识符作为父项引用进行声明；如果忽略标识符，相应数据流将依赖于“根数据流”。声明数据流依赖关系指出，应尽可能先向父数据流分配资源，然后再向其依赖项分配资源。换句话说，“请先处理和传输响应 D，然后再处理和传输响应 C”。</p>

<p>共享相同父项的数据流（即，同级数据流）应按其权重比例分配资源。 例如，如果数据流 A 的权重为 12，其同级数据流 B 的权重为 4，那么要确定每个数据流应接收的资源比例，请执行以下操作：</p>

<ol>
<li>将所有权重求和：<code>4 + 12 = 16</code></li>
<li>将每个数据流权重除以总权重：<code>A = 12/16, B = 4/16</code>因此，数据流 A 应获得四分之三的可用资源，数据流 B 应获得四分之一的可用资源；数据流 B 获得的资源是数据流 A 所获资源的三分之一。我们来看一下上图中的其他几个动手示例：顺序为从左到右：</li>
<li>数据流 A 和数据流 B 都没有指定父依赖项，依赖于显式“根数据流”；A 的权重为 12，B 的权重为 4。因此，根据比例权重：数据流 B 获得的资源是 A 所获资源的三分之一。</li>
<li>数据流 D 依赖于根数据流；C 依赖于 D。因此，D 应先于 C 获得完整资源分配。权重不重要，因为 C 的依赖关系拥有更高的优先级。</li>
<li>数据流 D 应先于 C 获得完整资源分配；C 应先于 A 和 B 获得完整资源分配；数据流 B 获得的资源是 A 所获资源的三分之一。</li>
<li>数据流 D 应先于 E 和 C 获得完整资源分配；E 和 C 应先于 A 和 B 获得相同的资源分配；A 和 B 应基于其权重获得比例分配。</li>
</ol>

<p>如上面的示例所示，数据流依赖关系和权重的组合明确表达了资源优先级，这是一种用于提升浏览性能的关键功能，网络中拥有多种资源类型，它们的依赖关系和权重各不相同。不仅如此，HTTP/2 协议还允许客户端随时更新这些优先级，进一步优化了浏览器性能。</p>

<h2 id="流控制">流控制</h2>

<p>流控制是一种阻止发送方向接收方发送大量数据的机制，以免超出后者的需求或处理能力：发送方可能非常繁忙、处于较高的负载之下，也可能仅仅希望为特定数据流分配固定量的资源。例如，客户端可能请求了一个具有较高优先级的大型视频流，但是用户已经暂停视频，客户端现在希望暂停或限制从服务器的传输，以免提取和缓冲不必要的数据。再比如，一个代理服务器可能具有较快的下游连接和较慢的上游连接，并且也希望调节下游连接传输数据的速度以匹配上游连接的速度来控制其资源利用率；等等。</p>

<p>上述要求会让您想到 TCP 流控制吗？您应当想到这一点；因为问题基本相同（请参阅<a href="https://hpbn.co/building-blocks-of-tcp/#flow-control">流控制</a>）。不过，由于 HTTP/2 数据流在一个 TCP 连接内复用，TCP 流控制既不够精细，也无法提供必要的应用级 API 来调节各个数据流的传输。为了解决这一问题，HTTP/2 提供了一组简单的构建块，这些构建块允许客户端和服务器实现其自己的数据流和连接级流控制：</p>

<ul>
<li>流控制具有方向性。每个接收方都可以根据自身需要选择为每个数据流和整个连接设置任意的窗口大小。</li>
<li>流控制基于信用。每个接收方都可以公布其初始连接和数据流流控制窗口（以字节为单位），每当发送方发出 <code>DATA</code>帧时都会减小，在接收方发出 <code>WINDOW_UPDATE</code> 帧时增大。</li>
<li>流控制无法停用。建立 HTTP/2 连接后，客户端将与服务器交换 <code>SETTINGS</code> 帧，这会在两个方向上设置流控制窗口。流控制窗口的默认值设为 65,535 字节，但是接收方可以设置一个较大的最大窗口大小（<code>2^31-1</code> 字节），并在接收到任意数据时通过发送 <code>WINDOW_UPDATE</code> 帧来维持这一大小。</li>
<li>流控制为逐跃点控制，而非端到端控制。即，可信中介可以使用它来控制资源使用，以及基于自身条件和启发式算法实现资源分配机制。</li>
</ul>

<p>HTTP/2 未指定任何特定算法来实现流控制。不过，它提供了简单的构建块并推迟了客户端和服务器实现，可以实现自定义策略来调节资源使用和分配，以及实现新传输能力，同时提升网络应用的实际性能和感知性能（请参阅<a href="https://hpbn.co/primer-on-web-performance/#speed-performance-and-human-perception">速度、性能和人类感知</a>）。</p>

<p>例如，应用层流控制允许浏览器仅提取一部分特定资源，通过将数据流流控制窗口减小为零来暂停提取，稍后再行恢复。换句话说，它允许浏览器提取图像预览或首次扫描结果，进行显示并允许其他高优先级提取继续，然后在更关键的资源完成加载后恢复提取。</p>

<p><img src="/Users/myonlyzzy/Desktop/屏幕快照 2018-03-30 下午2.13.59.png" alt="屏幕快照 2018-03-30 下午2.13.59" /></p>

<p>参考</p>

                        </div>

                        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/docker-proxy/">Docker Proxy</a></li>
        
        <li><a href="/post/kingshard/">Docker Proxy</a></li>
        
        <li><a href="/post/golang-net-http/">Golang Net Http</a></li>
        
        <li><a href="/about/">About</a></li>
        
        <li><a href="/post/istio/"></a></li>
        
    </ul>
</div>


                        <div class="post-meta meta-tags">
                            
                            没有标签
                            
                        </div>
                    </article>
                    
    

    
    
                </div>
            </div>
            <div id="secondary">
    <section class="widget">
        <form id="search" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://myonlyzzy.github.io">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://myonlyzzy.github.io/post/docker-proxy/" title="Docker Proxy">Docker Proxy</a>
    </li>
    
    <li>
        <a href="https://myonlyzzy.github.io/post/kingshard/" title="Docker Proxy">Docker Proxy</a>
    </li>
    
    <li>
        <a href="https://myonlyzzy.github.io/post/golang-net-http/" title="Golang Net Http">Golang Net Http</a>
    </li>
    
    <li>
        <a href="https://myonlyzzy.github.io/post/grpc-guides/" title=""></a>
    </li>
    
    <li>
        <a href="https://myonlyzzy.github.io/post/http2grpc/" title=""></a>
    </li>
    
    <li>
        <a href="https://myonlyzzy.github.io/post/istio/" title=""></a>
    </li>
    
    <li>
        <a href="https://myonlyzzy.github.io/post/tidb-tip/" title=""></a>
    </li>
    
    <li>
        <a href="https://myonlyzzy.github.io/post/golang-sync-pool/" title="golang-sync-Pool">golang-sync-Pool</a>
    </li>
    
    <li>
        <a href="https://myonlyzzy.github.io/post/k8s-ingress/" title="ks8 ingress">ks8 ingress</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://golang.org/" title="golang官网">golang官网</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://myonlyzzy.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
        </div>
    </div>
</div>
<footer id="footer">
    <div class="container">
        &copy; 2018 <a href="https://myonlyzzy.github.io">Myonlyzzy Blog By myonlyzzy</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="http://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/rujews/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    <script type="text/javascript">
    
    (function(){
        $("pre code").parent().addClass("line-numbers")
    }())

    window.MathJax = {
        tex2jax: {
            inlineMath: [ ['$','$'] ],
            processEscapes: true
        }
    };
    </script>
    <script type="text/javascript" src="/js/prism.js" async="true"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src="/js/totop.js?v=0.0.0" async=""></script>






</body>
</html>
